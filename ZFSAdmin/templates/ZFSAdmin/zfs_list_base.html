{% extends 'ZFSAdmin/base.html' %}
{% load static %}
{% block title %}FreeBSDashboard ZFSAdmin{% endblock %}
{% block the_body %}
    <span id="glyphicon_preload" style="position:relative;float:right;visibility:hidden">
        <span class="glyphicon glyphicon-briefcase"></span>
        <span class="glyphicon glyphicon-list"></span>
        <span class="glyphicon glyphicon-filter"></span>
        <span class="glyphicon glyphicon-refresh"></span>
        <span class="glyphicon glyphicon-check"></span>
        <span class="glyphicon glyphicon-duplicate"></span>
        <span class="glyphicon glyphicon-remove-circle"></span>
        <span class="glyphicon glyphicon-plus-sign"></span>
        <span class="glyphicon glyphicon-minus-sign"></span>
        <span class="glyphicon glyphicon-cog"></span>
    </span>
    <div id="main_buttons_container">
        <div id="main_buttons">
            <button type="button" class="btn btn-lg btn-primary" id="display_snapshots_button"><span
                    class="glyphicon glyphicon-list"></span> Show ZFS Snapshots
            </button>
            <button type="button" class="btn btn-lg btn-primary" id="take_snapshots_button"><span
                    class="glyphicon glyphicon-duplicate"></span> Take ZFS Snapshots
            </button>
            <button type="button" class="btn btn-lg btn-primary" id="change_filesystems"><span
                    class="glyphicon glyphicon-briefcase"></span> Administer File Systems
            </button>
        </div>
    </div>
    <hr>
    <div id="button_container">
        <div id="button_div">
            <div class="btn-toolbar" role="toolbar" aria-label="Snapshot administration">
                <div id="snapshot_admin_btn_group" class="btn-group" role="group" aria-label="Filter dataset">
                    <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"
                            aria-haspopup="true"
                            aria-expanded="false"
                            id="dataset-filter"><span class="glyphicon glyphicon-filter"
                                                      style="margin-right:0.5em;"></span>
                        Filter Dataset <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="{% url 'ZFSAdmin:index' %}?task_id={{ task_id }}&filter=all&process=snapshot_update">All</a>
                        </li>
                        {% for ds in datasets %}
                            <li>
                                <a href="{% url 'ZFSAdmin:index' %}?task_id={{ task_id }}&filter={{ ds }}&process=snapshot_update">{{ ds }}</a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                <button type="button" class="btn btn-primary" id="update_list"><span
                        class="glyphicon glyphicon-refresh"
                        style="margin-right:0.5em;"></span>Update List
                </button>
                <div class="btn-group" id="check_buttons" role="group" aria-label="Action on selected">
                    <button type="button" class="btn btn-primary" id="clone_selected"><span
                            class="glyphicon glyphicon-check" style="margin-right:0.5em;"></span><span
                            class="glyphicon glyphicon-duplicate"
                            style="margin-right:0.5em;"></span>Clone
                        Selected
                    </button>
                    <button type="button" class="btn btn-danger" id="delete_selected"><span
                            class="glyphicon glyphicon-check" style="margin-right:0.5em;"></span><span
                            class="glyphicon glyphicon-remove-circle"
                            style="margin-right:0.5em;"></span>Delete
                        Selected
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="progress" id="updating"></div>
    <div id="messages"></div>
    <div class="activity_container">
        <div id="take_snapshot_view">
            <div class="alert alert-info">
                <p>Select the dataset(s) you'd like to snapshot from the list below.</p>
                <p>You may select multiple.</p>
            </div>
            <div class="form-group">
                <form role="form" action="." method="post">
                    <select multiple id="datasets_select" name="datasets" class="form-control" style="min-height:600px">
                        {% for d in datasets %}
                            <option value="{{ d }}">{{ d }}</option>
                        {% endfor %}
                    </select>
                    <div class="submit">
                        <button type="button" class="btn btn-success" id="datasets_selected"><span
                                class="glyphicon glyphicon-duplicate"
                                style="margin-right:0.5em;"></span> Take
                            Snapshots
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div id="snapshot_table">
            <div class="table-responsive">
                {% if table %}
                    {% block snapshot_table %}{% endblock %}
                    {% block pagination %}{% endblock %}
                {% endif %}
            </div>
        </div>
        <div id="filesystem_management">
            <div id="button_container" style="margin-bottom:1em;min-height:2.5em;">
                <div id="manage_filesystem_button_div">
                    <div class="btn-toolbar" role="toolbar" aria-label="Snapshot administration">
                        <div class="btn-group" role="group" aria-label="Action on selected">
                            <button type="button" class="btn btn-success" id="create_filesystems"><span
                                    class="glyphicon glyphicon-plus-sign"
                                    style="margin-right:0.5em;"></span>Create File Systems
                            </button>
                            <button type="button" class="btn btn-danger" id="delete_filesystems"><span
                                    class="glyphicon glyphicon-minus-sign"
                                    style="margin-right:0.5em;"></span>Delete File Systems
                            </button>
                            <button type="button" class="btn btn-info" id="filesystem_props"><span
                                    class="glyphicon glyphicon-minus-sign"
                                    style="margin-right:0.5em;"></span>Show File System Properties
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            <div class="container-fluid">
                <div class="row intro">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-md-lg-12"></div>
                </div>
                <div class="row form-info-row">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-md-lg-12">
                        <div class="form_info alert alert-info"></div>
                    </div>
                </div>
                <div class="container-fluid">
                    <div class="row" id="manage_filesystems_form_row">
                        <div id="create_filesystem_form" class="col-xs-12 col-sm-12 col-md-12 col-md-lg-12">
                            <div class="row properties_dataset_choice">
                                <div class="col-xs-12 col-sm-12 col-md-12 col-md-lg-12 filesystem_choice">
                                    <div id="dataset_chooser">
                                        <form action="
                                                " method="post" id="dataset_query_form" role="form"
                                              onsubmit="event.preventDefault();">
                                            {{ dataset_form.non_form_errors }}
                                            {% csrf_token %}{{ dataset_form.datasets }} {{ dataset_form.errors }}
                                            <button class="btn btn-info" id="dataset_query_button">Get
                                                Properties
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <form role="form" id="manage_filesystems_form" action="" method="post"
                                  onsubmit="event.preventDefault();">
                                {% for form in formset %}
                                    {{ form.non_form_errors }}
                                {% endfor %}
                                {{ formset.non_form_errors }}
                                {% csrf_token %}
                                {% for form in formset %}
                                    <div id="filesystem_chooser">
                                        {{ form.datasets }} / {{ form.filesystem }}
                                        <div class="zws-red-alert">{{ form.dataset.errors }}</div>
                                        <div class="zws-red-alert">{{ form.filesystem.errors }}</div>
                                    </div>
                                    <div class="form-group create_filesystem_form">
                                        <div class="form_{{ forloop.counter }}">
                                            <div class="container-fluid">
                                                <div class="row">
                                                    <div class="col-xs-6 col-sm-6 col-md-6 col-md-lg-6">
                                                        <div class="selected_filesystem" style="margin-bottom:1em;">
                                                            <span class="label label-primary">Selected file system</span>
                                                            <span id="selected_filesystem_name"></span>
                                                        </div>
                                                        <div class="form_quota" style="margin-bottom:1em;">
                                                            <span class="label label-primary">{{ form.quota.label }}</span> {{ form.quota }}
                                                            GB {{ form.quota.errors }}
                                                        </div>
                                                        <div class="form_compression" style="margin-bottom:1em;"><span
                                                                class="label label-primary">{{ form.compression.label }}</span> {{ form.compression }} {{ form.compression.errors }}
                                                            <div id="id_form-{{ forloop.counter0 }}-compressratio"></div>
                                                        </div>
                                                        <div class="form_sharenfs" style="margin-bottom:1em;"><span
                                                                class="label label-primary">{{ form.sharenfs.label }}</span> {{ form.sharenfs }} {{ form.sharenfs.errors }}
                                                        </div>
                                                    </div>
                                                    <div class="col-xs-6 col-sm-6 col-md-6 col-md-lg-6 alert alert-warning">
                                                        <h1 class="small_h1">Additional Options</h1>
                                                        <div class="nfs-options alert alert-warning">
                                                            <h2 class="small_h2">NFS options</h2>
                                                            <div class="form-info-small">Check to set the -alldirs
                                                                property on the NFS share
                                                            </div>
                                                            <div class="form_sharenfs_alldirs "
                                                                 style="margin-bottom:1em;"><span
                                                                    class="label label-primary">{{ form.sharenfs_alldirs.label }}</span>
                                                                {{ form.sharenfs_alldirs }} {{ form.sharenfs_alldirs.errors }}
                                                            </div>
                                                            <div class="form-info-small">Separate multiple network
                                                                addresses with a pipe, e.g.
                                                                192.168.1.0/24|192.168.3.0/24
                                                            </div>
                                                            <div class="form_sharenfs_network"
                                                                 style="margin-bottom:1em;">
                                                   <span
                                                           class="label label-primary">{{ form.sharenfs_network.label }}</span>
                                                                {{ form.sharenfs_network }} {{ form.sharenfs_network.errors }}
                                                            </div>
                                                            <div class="form-info-small">Enter username to set the
                                                                -maproot option
                                                            </div>
                                                            <div class="form_sharenfs_maproot"
                                                                 style="margin-bottom:1em;">
                                                                <span class="label label-primary">{{ form.sharenfs_maproot.label }}</span>
                                                                {{ form.sharenfs_maproot }} {{ form.sharenfs_maproot.errors }}
                                                            </div>
                                                            {{ form.edit_mode }}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <hr>
                                        </div>
                                    </div>
                                {% endfor %}
                                {{ formset.management_form }}
                                <button class="btn btn-success" id="manage_filesystems_button">Create File
                                    System(s)
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row" id="filesystem_deletion_form_row">
        <div id="delete_filesystem_form" class="col-xs-12 col-sm-12 col-md-12 col-md-lg-12">
            <form action="" method="post" id="filesystem_deletion_form" role="form"
                  onsubmit="event.preventDefault();">
                {{ dataset_form.non_form_errors }}
                {% csrf_token %}
                {{ dataset_form.datasets }} {{ dataset_form.errors }}
                <button class="btn btn-danger" id="delete">Delete Selected Dataset</button>
            </form>
        </div>
    </div>
    <div id="dialog-confirm"></div>


{% endblock %}

{% block scripts %}
    <script>
        $(document).ready(function () {

                    var ERROR_MESSAGE = '<div class="alert alert-danger" role="alert">An error occurred!</div>';
                    var SUCCESS_MESSAGE = '<div class="alert alert-success" role="alert">Action successfully completed! Please wait ...</div>';
                    var INITIATE_DELETE_MESSAGE = '<div class="alert alert-warning" role="alert">Initiating deletion ...</div>';
                    var INITIATE_SNAPSHSOT_MESSAGE = '<div class="alert alert-warning" role="alert">Initiating snapshotting ...</div>';
                    var INITIATE_CLONE_MESSAGE = '<div class="alert alert-warning" role="alert">Initiating cloning ...</div>';
                    var INITIATE_FILESYSTEMS_CREATE_MESSAGE = '<div class="alert alert-warning" role="alert">Initiating file system creation ...</div>';
                    var INITIATE_FILESYSTEMS_EDIT_MESSAGE = '<div class="alert alert-warning" role="alert">Initiating file system editing ...</div>';
                    var SNAPSHOT_DELETION_SUCCESS_MESSAGE = '<div class="alert alert-warning" role="alert">Snaphot deletion initiated ...</div>';
                    var SNAPSHOT_CLONE_SUCCESS_MESSAGE = '<div class="alert alert-warning" role="alert">Snaphot cloning initiated ...</div>';
                    var SNAPSHOT_TAKE_SUCCESS_MESSAGE = '<div class="alert alert-warning" role="alert">Snaphot taking initiated ...</div>';
                    var FILESYSTEM_DELETION_SUCCESS_MESSAGE = '<div class="alert alert-warning" role="alert">File system deletion initiated ...</div>';
                    var FILESYSTEM_CREATE_SUCCESS_MESSAGE = '<div class="alert alert-warning" role="alert">File system creation initiated ...</div>';
                    var FILESYSTEM_EDIT_SUCCESS_MESSAGE = '<div class="alert alert-warning" role="alert">File system editing commenced ...</div>';
                    var STATUS_BAR_MESSAGE = 'Updating ... please wait ... patience is a virtue!';
                    var SNAPSHOT_DELETION_DIALOG_TITLE = 'Confirm that you wish to delete the following:';
                    var SNAPSHOT_CLONE_DIALOG_TITLE = 'Confirm that you wish to clone the following:';
                    var SNAPSHOT_TAKE_DIALOG_TITLE = 'Confirm that you wish to take snapshots of the following:';
                    var FILESYSTEM_DELETION_DIALOG_TITLE = "The following file system and ALL OF IT'S DESCENDENT " +
                            "FILESYSTEMS AND SNAPSHOTS will be permanently destroyed! " +
                            "Is that really what you want? 'Cause that's what'll happen!";
                    var FILESYSTEM_CHOSEN_DIALOG_TITLE = "The following file system names have been selected. Is this okay?";

                    function init() {
                        /* initial state */
                        var updating = '{{ updating }}';
                        $('#updating').hide();
                        $('.panel-footer').html("No running tasks.");
                        $('#button_div').hide();
                        $('#snapshot_table').hide();
                        $('#take_snapshot_view').hide();
                        $('#button_div').hide();
                        $('#main_buttons').hide();
                        $('#filesystem_management').hide();
                        $('#manage_filesystems_form_row').hide();
                        $('#filesystem_deletion_form_row').hide();
                        $('#show_props_form_row').hide();
                        $('div#properties_list').children().hide();
                        $('div#filesystem_chooser').hide();
                        $('div#dataset_chooser').hide();

                        /* if not updating, show the table etc */
                        if (updating != 'true') {
                            $('#updating').hide();
                            $('.panel-footer').html("No running tasks.");
                            $('#button_div').show("slide", {"direction": "right"}, 1000);
                            $('#main_buttons').show("slide", {"direction": "left"}, 1000);
                            $('#snapshot_table').show("slide", {"direction": "left"}, 1000);
                            $('#button_div').show("slide", {"direction": "right"}, 1000);
                            $('#manage_filesystem_button_div').hide();
                            $('#manage_filesystem_button_div').show("slide", {"direction": "left"}, 1000);
                        }
                        /* start the listeners */
                        ButtonListener();
                        /* run checked to bring in the table */
                        {% if stop_updating == 'true' %}
                            TaskUpdateStatusChecker(0, 'snapshot_update', null, false);
                        {%  else %}
                            TaskUpdateStatusChecker(0, 'snapshot_update', null, true);
                        {% endif %}
                        /* hide delete checkboxes if not logged in as superuser */
                        {% if not request.user.is_superuser %}
                            $('td.name, th.name').hide();
                        {% endif %}
                        /* add icons to column name - easier to do this here than in django_tables2 code */
                        $('th.name').html('<span class="glyphicon glyphicon-check" style="margin:0em 1em 0em 0em;"></span>Select for Action');
                    }

                    function TaskUpdateStatusChecker(loop_count, process, task_id, updating) {
                        if (!task_id) {
                            task_id = '{{ task_id }}';
                        }
                        if (updating == true) {
                            if (loop_count < 9) {
                                /* update progress checker - this loops until no update task is outstanding */
                                $.ajax({
                                    url: "{% url 'ZFSAdmin:task_checker' %}?task_id=" + task_id,
                                    type: "GET",
                                    dataType: "json",
                                    success: function (data) {
                                        /* IF NO UPDATE TASK RUNNING */
                                        if (data.updating == 'false') {
                                            if (data.error == 'false') {
                                                $('#messages').html(SUCCESS_MESSAGE);
                                                setTimeout(function () {
                                                    window.location.replace("{% url 'ZFSAdmin:index' %}?task_id=" + task_id + "&process=" + process);
                                                }, 950);
                                            } else {
                                                $('#button_div').hide("slide", {"direction": "right"}, 1000);
                                                $('#main_buttons').hide("slide", {"direction": "left"}, 1000);
                                                $('#updating').hide('slide, 1000');
                                                $('#messages').html(ERROR_MESSAGE + '<div class="alert alert-info">Error detail: ' + data.error_detail + '</div>');
                                                setTimeout(function () {
                                                    window.location.replace("{% url 'ZFSAdmin:index' %}");
                                                }, 5000);
                                            }
                                        }
                                        /* IF UPDATE TASK RUNNING */
                                        else if (data.updating == 'true') {
                                            $('#updating').html('<div class="progress-bar progress-bar-striped ' +
                                                    'progress-bar-warning active" ' +
                                                    'role="progressbar" aria-valuenow="100" ' +
                                                    'aria-valuemin="0" aria-valuemax="100" ' +
                                                    'style="width:100%;font-size:1.3em;">' +
                                                    '<span>' + STATUS_BAR_MESSAGE + '</span>' +
                                                    '</div>');
                                            $('.panel-footer').html("Updating in progress ...");
                                            $('#updating').show("slide", 1000);
                                            setTimeout(function () {
                                                /* loop the loop every 7 seconds (max 10 times - loopcount) */
                                                TaskUpdateStatusChecker(++loop_count, process, task_id, true);
                                            }, 7000);
                                        }
                                    },
                                    error: function (xhr, status) {
                                        $('#messages').html(ERROR_MESSAGE);
                                    },
                                    complete: function (xhr, status) {
                                    }
                                });
                            } else {
                                $('#messages').html(ERROR_MESSAGE);
                                $('#updating').hide("slide", 1000);
                            }
                        }
                    }

                    /* button listeners */
                    function ButtonListener() {

                        var form_count = parseInt('{{ formset_forms }}');

                        /* display existing snapshots */
                        document.getElementById("display_snapshots_button").onclick = function () {
                            $('#filesystem_management').hide("slide", {"direction": "left"}, 1000, function () {
                                $('#take_snapshot_view').hide("slide", {"direction": "left"}, 1000, function () {
                                    $('#button_div').show("slide", {"direction": "right"}, 1000, function () {
                                        $('#snapshot_table').show("slide", {"direction": "left"}, 1000);
                                    });
                                });
                            });
                        };
                        /* update snapshot list */
                        document.getElementById("update_list").onclick = function () {
                            window.location.replace("{% url 'ZFSAdmin:index' %}?process=snapshot_update");
                        };
                        /* take snaphots */
                        document.getElementById("take_snapshots_button").onclick = function () {
                            $('#filesystem_management').hide("slide", {"direction": "left"}, 1000, function () {
                                $('#snapshot_table').hide("slide", {"direction": "left"}, 1000, function () {
                                    $('#button_div').hide("slide", {"direction": "right"}, 1000, function () {
                                        $('#take_snapshot_view').show("slide", {"direction": "left"}, 1000);
                                    });
                                });
                            });
                        };
                        document.getElementById("datasets_selected").onclick = function () {
                            var selected = $('select[name=datasets]').val() + '';
                            if (selected.length > 0) {
                                var selected_list = selected.split(',');
                                var selected_list_html = '';
                                for (var i = 0; i < selected_list.length; i++) {
                                    selected_list_html += '<li>' + selected_list[i] + '</li>';
                                }
                                $("#dialog-confirm").html("<div class=\"alert alert-danger\">" +
                                        "<strong>" + SNAPSHOT_TAKE_DIALOG_TITLE + "</strong></div>"
                                        + "<ul>" + selected_list_html + "</ul>");
                                // Define the Dialog and its properties.
                                $("#dialog-confirm").dialog({
                                    dialogClass: 'no-close',
                                    resizable: true,
                                    modal: true,
                                    title: "Are you sure?!",
                                    height: 600,
                                    width: 800,
                                    hide: {effect: "fade", duration: 500},
                                    buttons: {
                                        "Yes, take the snapshots!": function () {
                                            $(this).dialog('close');
                                            snapshot_dialog_callback(true, selected_list);
                                        },
                                        "No, I do not want to take those snapshots after all": function () {
                                            $(this).dialog('close');
                                            snapshot_dialog_callback(false);
                                        }
                                    }
                                });
                            }
                        };
                        /* change file system properties */
                        document.getElementById("change_filesystems").onclick = function () {
                            $('#take_snapshot_view').hide("slide", {"direction": "left"}, 1000, function () {
                                $('#snapshot_table').hide("slide", {"direction": "left"}, 1000, function () {
                                    $('#button_div').hide("slide", {"direction": "right"}, 1000, function () {
                                        $('#filesystem_management').show("slide", {"direction": "left"}, 1000);
                                        $('div.form_info').html('<p>Select a function from the toolbar above</p>');
                                    });
                                });
                            });
                        };
                        /* delete snapshots */
                        document.getElementById("delete_selected").onclick = function () {
                            var toDelete = [];
                            var delete_list_html = '';
                            $('.action_checkbox:checked').each(function () {
                                toDelete.push(this.value);
                                delete_list_html += "<li>" + this.value + "</li>";
                            });
                            if (toDelete.length > 0) {
                                $("#dialog-confirm").html("<div class=\"alert alert-danger\">" +
                                        "<strong>" + SNAPSHOT_DELETION_DIALOG_TITLE + "</strong></div>"
                                        + "<ul>" + delete_list_html + "</ul>");
                                // Define the Dialog and its properties.
                                $("#dialog-confirm").dialog({
                                    dialogClass: 'no-close',
                                    resizable: true,
                                    modal: true,
                                    title: "Are you really sure?!",
                                    height: 600,
                                    width: 800,
                                    hide: {effect: "fade", duration: 500},
                                    buttons: {
                                        "Yes, they'll be gone forever, I understand!": function () {
                                            $(this).dialog('close');
                                            delete_dialog_callback(true, toDelete);
                                        },
                                        "No, I'm making a terrible mistake, do not delete!": function () {
                                            $(this).dialog('close');
                                            delete_dialog_callback(false);
                                        }
                                    }
                                });
                            }
                        };
                        /* clone snapshots */
                        document.getElementById("clone_selected").onclick = function () {
                            var toClone = [];
                            var clone_list_html = '';
                            $('.action_checkbox:checked').each(function () {
                                toClone.push(this.value);
                                clone_list_html += "<li>" + this.value + "</li>";
                            });
                            if (toClone.length > 0) {
                                $("#dialog-confirm").html("<div class=\"alert alert-danger\">" +
                                        "<strong>" + SNAPSHOT_CLONE_DIALOG_TITLE + "</strong></div>"
                                        + "<ul>" + clone_list_html + "</ul>");
                                // Define the Dialog and its properties.
                                $("#dialog-confirm").dialog({
                                    dialogClass: 'no-close',
                                    resizable: true,
                                    modal: true,
                                    title: "Confirm clone",
                                    height: 600,
                                    width: 800,
                                    hide: {effect: "fade", duration: 500},
                                    buttons: {
                                        "Yes, go ahead and clone": function () {
                                            $(this).dialog('close');
                                            clone_dialog_callback(true, toClone);
                                        },
                                        "No, do not clone": function () {
                                            $(this).dialog('close');
                                            clone_dialog_callback(false);
                                        }
                                    }
                                });
                            }
                        };
                        /* manage file systems buttons */
                        document.getElementById("delete").onclick = function () {
                            var selected = $('div#delete_filesystem_form select[name=datasets]').val() + '';
                            /* call the dialog */
                            if (selected && selected.length > 0) {
                                /* note: set this up for multi-select, even though only allowing single at present */
                                var selected_list = selected.split(',');
                                var selected_list_html = '';
                                for (var i = 0; i < selected_list.length; i++) {
                                    selected_list_html += '<li>' + selected_list[i] + '</li>';
                                }
                                $("#dialog-confirm").html("<div class=\"alert alert-danger\"><strong>"
                                        + FILESYSTEM_DELETION_DIALOG_TITLE + "</strong></div>"
                                        + "<ul>" + selected_list_html + "</ul>");
                                // Define the Dialog and its properties.
                                $("#dialog-confirm").dialog({
                                    dialogClass: 'no-close',
                                    resizable: true,
                                    modal: true,
                                    title: "Are you really sure?!",
                                    height: 600,
                                    width: 800,
                                    hide: {effect: "fade", duration: 500},
                                    buttons: {
                                        "Yes, they'll be gone forever, I understand!": function () {
                                            $(this).dialog('close');
                                            filesystem_delete_dialog_callback(true);
                                        },
                                        "No, I'm making a terrible mistake, do not delete!": function () {
                                            $(this).dialog('close');
                                            filesystem_delete_dialog_callback(false);
                                        }
                                    }
                                });
                            }
                        };
                        document.getElementById("manage_filesystems_button").onclick = function () {
                            var selected_dataset = [];
                            var new_filesystem = [];
                            var selected_dataset_list_html = '';
                            /* if create (not edit mode) */
                            if (!$('button#manage_filesystems_button').hasClass('filesystem_edit')) {
                                for (var c = 0; c < form_count; c++) {
                                    selected_dataset.push($('form#manage_filesystems_form select[name=form-' + c + '-datasets]').val());
                                    new_filesystem.push($('form#manage_filesystems_form input[name=form-' + c + '-filesystem]').val());
                                }
                            } else {
                                /* if edit mode */
                                selected_dataset.push($('div.form_1 span#selected_filesystem_name').text());
                            }
                            if (selected_dataset[0].length > 0) {
                                if (new_filesystem.length > 0) {
                                    /* new file system entered - create mode */
                                    /* note: set this up for multi-select, even though only allowing single at present */
                                    $.each(selected_dataset, function (index, value) {
                                        if (new_filesystem[index]) {
                                            selected_dataset_list_html += '<li>' + value + '/' + new_filesystem[index] + '</li>';
                                        }
                                    });
                                } else {
                                    /* edit mode */
                                    $.each(selected_dataset, function (index, value) {
                                        selected_dataset_list_html += '<li>' + value + '</li>';
                                    });
                                }
                                if (selected_dataset_list_html != '') {
                                    $("#dialog-confirm").html("<div class=\"alert alert-success\"><strong>"
                                            + FILESYSTEM_CHOSEN_DIALOG_TITLE + "</strong></div>"
                                            + "<ul>" + selected_dataset_list_html + "</ul>");
                                    // Define the Dialog and its properties.
                                    $("#dialog-confirm").dialog({
                                        dialogClass: 'no-close',
                                        resizable: true,
                                        modal: true,
                                        title: "Are you really sure?!",
                                        height: 600,
                                        width: 800,
                                        hide: {effect: "fade", duration: 500},
                                        buttons: {
                                            "Yes, proceed!": function () {
                                                $(this).dialog('close');
                                                filesystem_manage_dialog_callback(true);
                                            },
                                            "No, do not proceed": function () {
                                                $(this).dialog('close');
                                                filesystem_manage_dialog_callback(false);
                                            }
                                        }
                                    });
                                }
                            }
                        };

                        document.getElementById("create_filesystems").onclick = function () {
                            document.getElementById('manage_filesystems_form').reset();
                            for (var c = 1; c <= form_count; c++) {
                                $('div.form_' + c.toString()).show();
                                $('#id_form-' + (c - 1).toString() + '-edit_mode').val(false);
                            }
                            $('div.selected_filesystem').hide();
                            $('#filesystem_deletion_form_row').hide();
                            $('#manage_filesystems_form_row').show();
                            $('div.form_filesystems').show();
                            $('div#dataset_chooser').hide();
                            $('div#filesystem_chooser').show();
                            $('div.intro').html('<h2><span class="glyphicon glyphicon-plus-sign"></span> Create File System(s)</h2>');
                            $('div.form_info').html('<p>Enter the new filesystem details here (you have the option of creating 5 at a time).</p>' +
                                    '<p>Select the desired parent zpool/dataset from the dropdown menu first.</p>' +
                                    '<p>For example, select "zpool", then enter MyNewFileSystem, or MyNewFileSystem/MyNewFileSystemTwo.</p>' +
                                    '<p>Once you have defined your new filesystem(s), tap the "Create File System(s)" button at bottom of the form.</p>');
                            $('button#manage_filesystems_button').html('Create File System(s)').removeClass("filesystem_edit");

                        };
                        document.getElementById("delete_filesystems").onclick = function () {
                            $('#manage_filesystems_form_row').hide();
                            $('#filesystem_deletion_form_row').show();
                            $('div#dataset_chooser').hide();
                            $('div#filesystem_chooser').hide();
                            $('div.intro').html('<h2><span class="glyphicon glyphicon-minus-sign"></span> Delete File System(s)</h2>');
                            $('div.form_info').html('<p>Select the dataset you wish to delete from the list</p>');
                        };
                        document.getElementById("filesystem_props").onclick = function () {
                            document.getElementById('manage_filesystems_form').reset();
                            for (var c = 1; c <= form_count; c++) {
                                if (c != 1) {
                                    $('div.form_' + c.toString()).hide();
                                }
                            }
                            $('div.selected_filesystem').show();
                            $('#filesystem_deletion_form_row').hide();
                            $('#manage_filesystems_form_row').show();
                            $('div.form_filesystems').hide();
                            $('div#dataset_chooser').show();
                            $('div#filesystem_chooser').hide();
                            $('div.intro').html('<h2><span class="glyphicon glyphicon-question-sign"></span> Modify File System Properties(s)</h2>');
                            $('div.form_info').html('<p>Select the dataset you wish to query from the list</p>');
                            $('button#manage_filesystems_button').html('Edit File System Properties').addClass("filesystem_edit");
                        };
                        document.getElementById("dataset_query_button").onclick = function () {
                            /* initiates on page load */
                            var fs_selected = $('form#dataset_query_form select[name=datasets]').val();
                            {% for fs, props in properties.items %}
                                if ('{{ fs }}' == fs_selected) {
                                    $('span#selected_filesystem_name').html(fs_selected);
                                    /* set the selected dataset for the hidden (in edit mode) id_form-0-datasets field */
                                    $('#id_form-0-datasets').val(fs_selected);
                                    $('#id_form-0-compression').val('{{ props.compression.value }}');
                                    $('#id_form-0-quota').val('{{ props.quota.value }}');
                                    $('#id_form-0-edit_mode').val(true);
                                    $('#id_form-0-compressratio').html('<span class="label label-primary">Compress ratio</span> {{ props.compressratio.value }}');
                                    if ('{{ props.sharenfs.value.sharenfs }}' == 'true') {
                                        $('#id_form-0-sharenfs').prop('checked', true);
                                    } else {
                                        $('#id_form-0-sharenfs').prop('checked', false);
                                    }
                                    if ('{{ props.sharenfs.value.alldirs }}' == 'true') {
                                        $('#id_form-0-sharenfs_alldirs').prop('checked', true);
                                    } else {
                                        $('#id_form-0-sharenfs_alldirs').prop('checked', false);
                                    }
                                    $('#id_form-0-sharenfs_network').val('{{ props.sharenfs.value.network }}');
                                    $('#id_form-0-sharenfs_maproot').val('{{ props.sharenfs.value.maproot }}');
                                }
                            {% endfor %}
                        }
                    }

                    /* dialogs */

                    function filesystem_delete_dialog_callback(value) {
                        if (value) {
                            $('#messages').html(INITIATE_DELETE_MESSAGE);
                            var postData = $('#filesystem_deletion_form').serializeArray();
                            $.ajax(
                                    {
                                        url: "{% url 'ZFSAdmin:delete_filesystem' %}",
                                        headers: {"X-CSRFToken": '{{ csrf_token }}'},
                                        type: "POST",
                                        data: postData,
                                        success: function (data, textStatus, jqXHR) {
                                            if (textStatus == 'success') {
                                                $('#messages').html(FILESYSTEM_DELETION_SUCCESS_MESSAGE);
                                                TaskUpdateStatusChecker(0, 'filesystem_management', data, true);
                                            } else {
                                                $('#messages').html(ERROR_MESSAGE + ' : Delete file system task failed to initiate!');
                                                setTimeout(function () {
                                                    window.location.replace("{% url 'ZFSAdmin:index' %}");
                                                }, 5000);
                                            }
                                        },
                                        error: function (jqXHR, textStatus, errorThrown) {
                                            $('#messages').html(ERROR_MESSAGE);
                                            setTimeout(function () {
                                                window.location.replace("{% url 'ZFSAdmin:index' %}");
                                            }, 5000);
                                        }
                                    });
                        }
                        else {
                            /* nothing */
                        }
                    }

                    function filesystem_manage_dialog_callback(value) {
                        if (value) {
                            var initiateMessage;
                            var successMessage;
                            var url = "{% url 'ZFSAdmin:manage_filesystem' %}";
                            if (!$('button#manage_filesystems_button').hasClass('filesystem_edit')) {
                                /* create mode */
                                initiateMessage = INITIATE_FILESYSTEMS_CREATE_MESSAGE;
                                successMessage = FILESYSTEM_CREATE_SUCCESS_MESSAGE;
                            } else {
                                /* edit mode */
                                initiateMessage = INITIATE_FILESYSTEMS_EDIT_MESSAGE;
                                successMessage = FILESYSTEM_EDIT_SUCCESS_MESSAGE;
                            }
                            $('#messages').html(initiateMessage);


                            var postData = $('form#manage_filesystems_form').serializeArray();
                            $.ajax(
                                    {
                                        url: url,
                                        headers: {"X-CSRFToken": '{{ csrf_token }}'},
                                        type: "POST",
                                        data: postData,
                                        success: function (data, textStatus, jqXHR) {
                                            if (textStatus == 'success') {
                                                if (data.indexOf('ERROR:') > -1) {
                                                    $('html,body').animate({
                                                                scrollTop: $('body').offset().top
                                                            },
                                                            'slow');
                                                    $('#messages').html('<div class="alert alert-danger" style="margin-bottom:1em;">' + data + '</div>');
                                                }
                                                else {
                                                    $('#messages').html(successMessage);
                                                    $('div#filesystem_management').hide("slide", {"direction": "left"}, 1000);
                                                    TaskUpdateStatusChecker(0, 'filesystem_management', data, true);
                                                }
                                            } else {
                                                $('#messages').html(ERROR_MESSAGE + ' : Create file system task failed to initiate!');
                                                setTimeout(function () {
                                                    window.location.replace("{% url 'ZFSAdmin:index' %}");
                                                }, 5000);
                                            }
                                        },
                                        error: function (jqXHR, textStatus, errorThrown) {
                                            $('#messages').html(ERROR_MESSAGE);
                                            $('html,body').animate({
                                                        scrollTop: $('body').offset().top
                                                    },
                                                    'slow');
                                            setTimeout(function () {
                                                window.location.replace("{% url 'ZFSAdmin:index' %}");
                                            }, 5000);
                                        }
                                    });
                        }
                        else {
                            /* nothing */
                        }
                    }

                    function delete_dialog_callback(value, toDelete) {
                        if (value && toDelete) {
                            $('#messages').html(INITIATE_DELETE_MESSAGE);
                            $.ajax({
                                type: "POST",
                                url: "{% url 'ZFSAdmin:delete_snapshots' %}",
                                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                                data: JSON.stringify($({sendData: toDelete})),
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                success: function (result) {
                                    if (result.success == 'true') {
                                        $('#messages').html(SNAPSHOT_DELETION_SUCCESS_MESSAGE);
                                        TaskUpdateStatusChecker(0, 'snapshot_delete', result.task_id, true);
                                    } else {
                                        $('#messages').html(ERROR_MESSAGE + '<div>Error Details: ' + result.error + '</div>');
                                        setTimeout(function () {
                                            window.location.replace("{% url 'ZFSAdmin:index' %}");
                                        }, 1000)
                                    }
                                },
                                error: function (result) {
                                    $('#messages').html(ERROR_MESSAGE + '<div>Error Details: ' + result.error + '</div>');
                                    setTimeout(function () {
                                        window.location.replace("{% url 'ZFSAdmin:index' %}");
                                    }, 1000);
                                },
                                complete: function (xhr, status) {
                                    /* do nothing */
                                }
                            });
                        } else {
                            /* nothing ... */
                        }
                    }


                    function clone_dialog_callback(value, toClone) {
                        if (value && toClone) {
                            $('#messages').html(INITIATE_CLONE_MESSAGE);
                            $.ajax({
                                type: "POST",
                                url: "{% url 'ZFSAdmin:clone_snapshots' %}",
                                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                                data: JSON.stringify($({sendData: toClone})),
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                success: function (result) {
                                    if (result.success == 'true') {
                                        $('#messages').html(SNAPSHOT_CLONE_SUCCESS_MESSAGE);
                                        TaskUpdateStatusChecker(0, 'snapshot_clone', result.task_id, true);
                                    } else {
                                        $('#messages').html(ERROR_MESSAGE + '<div>Error Details: ' + result.error + '</div>')
                                        setTimeout(function () {
                                            window.location.replace("{% url 'ZFSAdmin:index' %}");
                                        }, 1000)
                                    }
                                },
                                error: function (result) {
                                    $('#messages').html(ERROR_MESSAGE + '<div>Error Details: ' + result.error + '</div>');
                                    setTimeout(function () {
                                        window.location.replace("{% url 'ZFSAdmin:index' %}");
                                    }, 1000);
                                }
                            });
                        } else {
                            /* nothing ... */
                        }
                    }

                    function snapshot_dialog_callback(value, toSnapshot) {
                        if (value && toSnapshot) {
                            $('#messages').html(INITIATE_SNAPSHSOT_MESSAGE);
                            $.ajax({
                                type: "POST",
                                url: "{% url 'ZFSAdmin:take_snapshots' %}",
                                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                                data: JSON.stringify($({sendData: toSnapshot})),
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                success: function (result) {
                                    if (result.success == 'true') {
                                        $('#messages').html(SNAPSHOT_TAKE_SUCCESS_MESSAGE);
                                        TaskUpdateStatusChecker(0, 'snapshot_take', result.task_id, true);
                                    } else {
                                        $('#messages').html(ERROR_MESSAGE + '<div>Error Details: ' + result.error + '</div>')
                                        setTimeout(function () {
                                            window.location.replace("{% url 'ZFSAdmin:index' %}");
                                        }, 1000)
                                    }
                                },
                                error: function (result) {
                                    $('#messages').html(ERROR_MESSAGE + '<div>Error Details: ' + result.error + '</div>');
                                    setTimeout(function () {
                                        window.location.replace("{% url 'ZFSAdmin:index' %}");
                                    }, 1000);
                                }
                            });
                        } else {
                            /* nothing ... */
                        }
                    }

                    /* RUN THE SCRIPTS */
                    init();
                }
        )
        ;
    </script>
{% endblock %}