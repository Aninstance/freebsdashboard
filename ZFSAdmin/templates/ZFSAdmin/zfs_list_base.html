{% extends 'ZFSAdmin/base.html' %}
{% load static %}
{% block title %}FreeBSDashboard ZFSAdmin{% endblock %}
{% block the_body %}
    <div id="button_container" style="margin-bottom:1em;min-height:2.5em;">
        <div id="button_div">
            <span><a class="btn btn-primary" id="update_list">Update list</a></span>
            <div class="btn-group">
                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"
                        aria-haspopup="true"
                        aria-expanded="false"
                        id="dataset-filter">
                    Filter Dataset <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li><a href="{% url 'ZFSAdmin:index' %}">All</a></li>
                    {% for ds in datasets %}
                        <li><a href="{% url 'ZFSAdmin:index' %}?filter={{ ds }}">{{ ds }}</a></li>
                    {% endfor %}
                </ul>
            </div>
            <span><a class="btn btn-primary" id="take_snapshot">Take Snapshot</a></span>
            <span><a class="btn btn-danger" id="delete_selected">Delete Selected</a></span>
        </div>
    </div>
    <div class="progress" id="updating"></div>
    <div id="messages">{{ gui_message }}</div>
    <div class="table-responsive">
        {% if table %}
            {#            {% render_table table %}#}
            <div id="snapshot_table">
                {% block snapshot_table %}{% endblock %}
                {% block pagination %}{% endblock %}
            </div>
        {% endif %}
    </div>

    <div id="dialog-confirm"></div>

{% endblock %}

{% block scripts %}
    <script>
        $(document).ready(function () {

            var ERROR_MESSAGE = '<div class="alert alert-danger" role="alert">An update error occurred!</div>';
            var INITIATE_DELETE_MESSAGE = '<div class="alert alert-warning" role="alert">Initiating deletion ...</div>';
            var STATUS_BAR_MESSAGE = 'Updating ... please wait ... patience is a virtue!';
            var SNAPSHOT_DELETION_DIALOG_TITLE = 'Confirm that you wish to delete the following:';

            function init() {
                /* hide the table as default until task update status is determined */
                $('#snapshot_table').hide();
                $('#updating').html('<div class="progress-bar progress-bar-striped ' +
                        'progress-bar-warning active" ' +
                        'role="progressbar" aria-valuenow="100" ' +
                        'aria-valuemin="0" aria-valuemax="100" ' +
                        'style="width:100%;font-size:1.3em;">' +
                        '<span>' + STATUS_BAR_MESSAGE + '</span>' +
                        '</div>').hide();
                /* and hide the buttons to stop any tomfoolery until status is known */
                $('#button_div').hide();
                /* start the listeners */
                UpdateButtonListener();
                /* run checker on page load in case currently running task in progress */
                TaskUpdateStatusChecker(page_load='true');
            }

            function UpdateButtonListener() {
                /* button listener */
                document.getElementById("update_list").onclick = function () {
                    UpdateSnapshots();
                };
                document.getElementById("take_snapshot").onclick = function () {
                    window.location.replace("{% url 'ZFSAdmin:take_snapshot' %}");
                };
                document.getElementById("delete_selected").onclick = function () {
                    var toDelete = [];
                    var delete_list_html = '';
                    $('.delete_checkbox:checked').each(function () {
                        toDelete.push(this.value);
                        delete_list_html += "<li>" + this.value + "</li>";
                    });
                    if (toDelete.length > 0) {
                        $("#dialog-confirm").html("<strong>" + SNAPSHOT_DELETION_DIALOG_TITLE + "</strong>"
                                + "<ul>" + delete_list_html + "</ul>");
                        // Define the Dialog and its properties.
                        $("#dialog-confirm").dialog({
                            dialogClass: 'no-close',
                            resizable: true,
                            modal: true,
                            title: "Are you really sure?!",
                            height: 600,
                            width: 800,
                            hide: {effect: "explode", duration: 500},
                            buttons: {
                                "Yes, they'll be gone forever, I understand!": function () {
                                    $(this).dialog('close');
                                    dialog_callback(true, toDelete);
                                },
                                "No, I'm making a terrible mistake, do not delete!": function () {
                                    $(this).dialog('close');
                                    dialog_callback(false);
                                }
                            }
                        });
                    }
                }
            }

            function dialog_callback(value, toDelete) {
                if (value && toDelete) {
                    $('#messages').html(INITIATE_DELETE_MESSAGE);
                    $.ajax({
                        type: "POST",
                        url: "{% url 'ZFSAdmin:delete_snapshots' %}",
                        headers: {"X-CSRFToken": '{{ csrf_token }}'},
                        data: JSON.stringify($({sendData: toDelete})),
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (result) {
                            if (result.success == 'true') {
                                setTimeout(function () {
                                    window.location.replace("{% url 'ZFSAdmin:index' %}");
                                }, 1000);
                            } else {
                                setTimeout(function () {
                                    $('#messages').html(ERROR_MESSAGE + '<div>Error Details: ' + result.error + '</div>')
                                }, 1000)
                            }
                        },
                        error: function (result) {
                            $('#messages').html(ERROR_MESSAGE);
                            setTimeout(function () {
                                window.location.replace("{% url 'ZFSAdmin:index' %}");
                            }, 1000);
                        }
                    });
                } else {
                    /* nothing ... */
                }
            }

            function TaskUpdateStatusChecker(page_load) {
                /* update progress checker - this loops until no update task is outstanding */
                $.ajax({
                    url: " {% url 'ZFSAdmin:snapshot_task_manager' %}?page_load=" + page_load,
                    type: "GET",
                    dataType: "json",
                    success: function (data) {
                        /* IF NO UPDATE TASK RUNNING */
                        if (data.updating == 'false') {
                            /* UPDATE TASK JUST COMPLETED - REQUIRES PAGE RELOAD TO UPDATE SNAPSHOT TABLE */
                            if (data.page_load == 'false') {
                                if (data.error == 'false') {
                                    window.location.replace("{% url 'ZFSAdmin:index' %}")
                                } else {
                                    $('#messages').html(ERROR_MESSAGE + '<div>Error detail: ' + data.error_detail + '</div>');
                                    setTimeout(function () {
                                        window.location.replace("{% url 'ZFSAdmin:index' %}");
                                    }, 7000);
                                }
                            }
                            /* PAGE JUST (RE)LOADED */
                            else {
                                $('#snapshot_table').show("slide", 1000);
                                $('.panel-footer').html('No updates running.');
                                $('#updating').hide("slide", 1000);
                                $('#button_div').show("slide", {"direction": "right"}, 1000);
                            }
                        }
                        /* IF UPDATE TASK RUNNING */
                        else if (data.updating == 'true') {
                            $('.panel-footer').html("Updating in progress ...");
                            $('#updating').show("slide", 1000);
                            $('#button_div').hide("slide", {"direction": "right"}, 1000);
                            setTimeout(function () {
                                /* loop the loop every 7 seconds */
                                TaskUpdateStatusChecker(page_load = 'false');
                            }, 7000);
                        }
                    },
                    error: function (xhr, status) {
                        $('#messages').html(ERROR_MESSAGE);
                    },
                    complete: function (xhr, status) {
                    }
                });
            }


            function UpdateSnapshots() {
                /* initiate snapshot update */
                $.ajax({
                    url: " {% url 'ZFSAdmin:update_snapshots' %}",
                    type: "GET",
                    dataType: "json",
                    success: function (data) {
                        if (data.task_id) {
                            TaskUpdateStatusChecker(page_load = 'true');
                        }
                        else {
                            $('#messages').html(ERROR_MESSAGE);
                        }
                    },
                    error: function (xhr, status) {
                        $('#messages').html(ERROR_MESSAGE);
                    }
                });
            }

            /* RUN THE SCRIPTS */
            init();
        });
    </script>
{% endblock %}